{% extends "index.html" %} {% block title %} {% if event.event_id %} {{
event.name | safe }} {% else %} New event {% endif %} {% endblock %} {% block
content %}
<div id="flash-container" class="fixed top-4 right-4 z-50"></div>

<div class="container mx-auto px-4 py-8">
    <h1 class="text-3xl font-bold text-center text-blue-600 mb-8">
        {% if event.event_id %} {{ event.name | safe }} {% else %} New Event {%
        endif %}
    </h1>

    <!-- Event Details -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
        <aside class="md:col-span-1">
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-2xl font-bold text-blue-600 mb-4">
                    Event Details
                </h2>
                <p class="mb-2">
                    <strong>Name:</strong> {{ event.name | safe }}
                </p>
                <p class="mb-2"><strong>Date:</strong> {{ event.date }}</p>
                <p class="mb-2">
                    <strong>Location:</strong> {{ event.location }}
                </p>
                <p class="mb-2">
                    <strong>Description:</strong> {{ event.description }}
                </p>
                <p class="mb-2">
                    <strong>Status:</strong>
                    {% if event.status == EventStatus.ACTIVE %}
                    <span class="text-green-600 font-semibold">Active</span>
                    {% elif event.status == EventStatus.CANCELLED %}
                    <span class="text-red-600 font-semibold">Cancelled</span>
                    {% elif event.status == EventStatus.COMPLETED %}
                    <span class="text-blue-600 font-semibold">Completed</span>
                    {% else %}
                    <span class="text-gray-600">{{ event.status }}</span>
                    {% endif %}
                </p>
                <p class="mb-2">
                    <strong>Guests:</strong> {{ event.total_guests }} ({{
                    event.confirmed_guests }} confirmed, {{ event.pending_guests
                    }} pending)
                </p>
                <p class="mb-2">
                    <strong>Budget:</strong> AED {{
                    "{:,.2f}".format(event.budget or 0) }} (Spent: AED {{
                    "{:,.2f}".format(event.spent_budget or 0) }}, Remaining: AED
                    {{ "{:,.2f}".format(event.remaining_budget or 0) }})
                </p>
                <div class="mb-2">
                    <p class="mb-2"><strong>Expenses:</strong></p>
                    <ul class="list-disc pl-5">
                        {% for description, amount in event.expenses.items() %}
                        <li>
                            {{ description }}: AED {{ "{:,.2f}".format(amount)
                            }}
                        </li>
                        {% endfor %}
                    </ul>
                </div>
                <div class="mt-4">
                    <p class="mb-2">
                        <strong>Planning Progress:</strong> {{
                        "%.0f"|format(event.progress) }}%
                    </p>
                    <div class="bg-gray-200 rounded-full h-2.5">
                        <div
                            class="bg-blue-600 h-2.5 rounded-full"
                            style="width: {{ event.progress }}%"
                        ></div>
                    </div>
                </div>
                <div class="mt-6 space-y-2">
                    <button
                        onclick="openEditModal()"
                        class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded"
                    >
                        Edit Event Details
                    </button>

                    <button
                        onclick="deleteEvent()"
                        class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded"
                    >
                        Delete Event
                    </button>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="md:col-span-2">
            <!-- Tabs -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex mb-6 space-x-2">
                    <button
                        class="tab-btn active px-4 py-2 rounded-md"
                        data-tab="vendors"
                    >
                        Vendors
                    </button>
                    <button
                        class="tab-btn px-4 py-2 rounded-md"
                        data-tab="guests"
                    >
                        Guest List
                    </button>
                    <button
                        class="tab-btn px-4 py-2 rounded-md"
                        data-tab="tasks"
                    >
                        Tasks
                    </button>
                    <button
                        class="tab-btn px-4 py-2 rounded-md"
                        data-tab="budget"
                    >
                        Budget
                    </button>
                </div>

                <!-- Vendors Tab -->
                <div id="vendors-content" class="tab-content">
                    <div class="flex justify-between mb-4">
                        <a
                            href="{{ url_for('app_views.vendors', event_id=event.event_id) }}"
                            class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded inline-flex items-center"
                        >
                            <svg
                                class="w-5 h-5 mr-2"
                                fill="none"
                                stroke="currentColor"
                                viewBox="0 0 24 24"
                            >
                                <path
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    stroke-width="2"
                                    d="M12 6v6m0 0v6m0-6h6m-6 0H6"
                                />
                            </svg>
                            Add New Vendor
                        </a>
                    </div>

                    <!-- Existing vendors list -->
                    <ul class="space-y-4">
                        {% if event.vendors %} {% for vendor in event.vendors %}
                        <li class="border rounded-lg p-4">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-4">
                                    <img
                                        src="{{ vendor.image_path }}"
                                        alt="{{ vendor.name }}"
                                        class="w-24 h-24 object-cover rounded-lg"
                                    />
                                    <div>
                                        <h3 class="text-lg font-semibold">
                                            {{ vendor.name }}
                                        </h3>
                                        <p class="text-gray-600">
                                            {{ vendor.description }}
                                        </p>
                                        <p>
                                            <strong>Contact:</strong>
                                            <a
                                                href="tel:{{ vendor.phone_number }}"
                                                class="text-blue-600"
                                                >{{ vendor.phone_number }}</a
                                            >
                                        </p>
                                        <p>
                                            <strong>Email:</strong>
                                            <a
                                                href="mailto:{{ vendor.email }}"
                                                class="text-blue-600"
                                                >{{ vendor.email }}</a
                                            >
                                        </p>
                                        <p>
                                            <strong>Status:</strong>
                                            <span
                                                class="font-semibold {% if vendor.status == 'confirmed' %}text-green-600 {% else %}text-yellow-600{% endif %}"
                                            >
                                                {{ vendor.status|capitalize }}
                                            </span>
                                        </p>
                                    </div>
                                </div>
                                <!-- Actions -->
                                <div class="flex flex-col space-y-2">
                                    <form
                                        method="POST"
                                        action="{{ url_for('app_views.update_vendor_status', event_id=event.event_id, vendor_id=vendor.vendor_id) }}"
                                        class="inline-block"
                                    >
                                        <select
                                            name="status"
                                            onchange="this.form.submit()"
                                            class="rounded-lg border-gray-300 text-sm focus:ring-blue-500 focus:border-blue-500"
                                        >
                                            <option
                                                value="pending"
                                                {%
                                                if
                                                vendor.status=="pending"
                                                %}selected{%
                                                endif
                                                %}
                                            >
                                                Pending
                                            </option>
                                            <option
                                                value="confirmed"
                                                {%
                                                if
                                                vendor.status=="confirmed"
                                                %}selected{%
                                                endif
                                                %}
                                            >
                                                Confirmed
                                            </option>
                                        </select>
                                    </form>
                                    <button
                                        onclick="removeVendor('{{ vendor.vendor_id }}')"
                                        class="inline-flex items-center px-3 py-2 text-sm font-medium text-white bg-red-500 rounded-md hover:bg-red-600 transition-colors"
                                    >
                                        <svg
                                            class="w-4 h-4 mr-2"
                                            fill="none"
                                            stroke="currentColor"
                                            viewBox="0 0 24 24"
                                        >
                                            <path
                                                stroke-linecap="round"
                                                stroke-linejoin="round"
                                                stroke-width="2"
                                                d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"
                                            />
                                        </svg>
                                        Remove vendor
                                    </button>
                                </div>
                            </div>
                        </li>
                        {% endfor %} {% else %}
                        <li class="text-gray-500 text-center py-4">
                            No vendors added yet. Click "Add New Vendor" to get
                            started.
                        </li>
                        {% endif %}
                    </ul>
                </div>

                <!-- Guests Tab -->
                <div
                    id="guests-content"
                    class="tab-content"
                    style="display: none"
                >
                    <div class="flex justify-between items-center mb-4">
                        <button
                            onclick="openGuestModal()"
                            class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded"
                        >
                            Add Guest
                        </button>
                        <button
                            onclick="sendBulkInvitations()"
                            class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded flex items-center"
                        >
                            <svg
                                class="w-5 h-5 mr-2"
                                fill="none"
                                stroke="currentColor"
                                viewBox="0 0 24 24"
                            >
                                <path
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    stroke-width="2"
                                    d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"
                                />
                            </svg>
                            Send All Invitations
                        </button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead>
                                <tr class="bg-gray-100">
                                    <th class="px-4 py-2 text-left">Name</th>
                                    <th class="px-4 py-2 text-left">Email</th>
                                    <th class="px-4 py-2 text-left">Phone</th>
                                    <th class="px-4 py-2 text-left">Status</th>
                                    <th class="px-4 py-2 text-left">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for guest in event.guests %}
                                <tr
                                    id="guest-{{ guest.guest_id }}"
                                    class="border-b hover:bg-gray-50"
                                >
                                    <td class="px-4 py-2">{{ guest.name }}</td>
                                    <td class="px-4 py-2">{{ guest.email }}</td>
                                    <td class="px-4 py-2">
                                        {{ guest.phone or 'N/A' }}
                                    </td>
                                    <td class="px-4 py-2">
                                        <span
                                            class="px-2 py-1 rounded-full text-sm {% if guest.status == 'Accepted' %} bg-green-100 text-green-800 {% elif guest.status == 'Declined' %} bg-red-100 text-red-800 {% else %} bg-yellow-100 text-yellow-800 {% endif %}"
                                        >
                                            {{ guest.status or 'Pending' }}
                                        </span>
                                    </td>
                                    <td class="px-4 py-2">
                                        <div class="flex space-x-2">
                                            <button
                                                onclick="sendInvitation({{ guest.guest_id }})"
                                                class="text-blue-600 hover:text-blue-800"
                                                title="Send Invitation"
                                            >
                                                <svg
                                                    class="w-5 h-5"
                                                    fill="none"
                                                    stroke="currentColor"
                                                    viewBox="0 0 24 24"
                                                >
                                                    <path
                                                        stroke-linecap="round"
                                                        stroke-linejoin="round"
                                                        stroke-width="2"
                                                        d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"
                                                    />
                                                </svg>
                                            </button>
                                            <button
                                                onclick="openGuestModal({{ guest.guest_id }})"
                                                class="text-yellow-600 hover:text-yellow-800"
                                                title="Edit Guest"
                                            >
                                                <svg
                                                    class="w-5 h-5"
                                                    fill="none"
                                                    stroke="currentColor"
                                                    viewBox="0 0 24 24"
                                                >
                                                    <path
                                                        stroke-linecap="round"
                                                        stroke-linejoin="round"
                                                        stroke-width="2"
                                                        d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"
                                                    />
                                                </svg>
                                            </button>
                                            <button
                                                onclick="deleteGuest({{ guest.guest_id }})"
                                                class="text-red-600 hover:text-red-800"
                                                title="Delete Guest"
                                            >
                                                <svg
                                                    class="w-5 h-5"
                                                    fill="none"
                                                    stroke="currentColor"
                                                    viewBox="0 0 24 24"
                                                >
                                                    <path
                                                        stroke-linecap="round"
                                                        stroke-linejoin="round"
                                                        stroke-width="2"
                                                        d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"
                                                    />
                                                </svg>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Tasks Tab -->
                <div
                    id="tasks-content"
                    class="tab-content"
                    style="display: none"
                >
                    <button
                        onclick="openTaskModal()"
                        class="mb-4 bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded"
                    >
                        Add Task
                    </button>

                    <ul class="space-y-4">
                        {% for task in event.tasks %}
                        <li
                            class="flex items-center justify-between border-b pb-2"
                            id="task-{{ task.task_id }}"
                        >
                            <div class="flex items-center space-x-4">
                                <input
                                    type="checkbox"
                                    {%
                                    if
                                    task.status=="completed"
                                    %}
                                    checked
                                    {%
                                    endif
                                    %}
                                    onchange="updateTaskStatus({{ task.task_id }}, this.checked)"
                                    class="form-checkbox h-5 w-5 text-blue-600 rounded"
                                />
                                <div>
                                    <h3
                                        class="font-semibold {% if task.status == 'completed' %}line-through text-gray-500{% endif %}"
                                    >
                                        {{ task.description }}
                                    </h3>
                                    <p class="text-sm text-gray-600">
                                        Due: {{
                                        task.due_date.strftime('%Y-%m-%d') }}
                                    </p>
                                </div>
                            </div>
                            <div class="flex space-x-2">
                                <!-- Edit Icon -->
                                <button
                                    onclick="openTaskModal({{ task.task_id }})"
                                    class="text-blue-600 hover:text-blue-800"
                                >
                                    <svg
                                        class="w-5 h-5"
                                        fill="none"
                                        stroke="currentColor"
                                        viewBox="0 0 24 24"
                                    >
                                        <path
                                            stroke-linecap="round"
                                            stroke-linejoin="round"
                                            stroke-width="2"
                                            d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"
                                        />
                                    </svg>
                                </button>
                                <button
                                    onclick="deleteTask({{ task.task_id }})"
                                    class="text-red-600 hover:text-red-800"
                                >
                                    <svg
                                        class="w-5 h-5"
                                        fill="none"
                                        stroke="currentColor"
                                        viewBox="0 0 24 24"
                                    >
                                        <path
                                            stroke-linecap="round"
                                            stroke-linejoin="round"
                                            stroke-width="2"
                                            d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"
                                        />
                                    </svg>
                                </button>
                            </div>
                        </li>
                        {% endfor %}
                    </ul>
                </div>

                <!-- Budget tab content -->
                <div
                    id="budget-content"
                    class="tab-content"
                    style="display: none"
                >
                    <div class="mb-4">
                        <p>
                            Spent: AED {{ "{:,.2f}".format(event.spent_budget or
                            0) }}
                        </p>
                        <p>
                            Remaining: AED {{
                            "{:,.2f}".format((event.total_budget or 0) -
                            (event.spent_budget or 0)) }}
                        </p>
                        <button
                            onclick="openExpenseModal()"
                            class="mt-4 bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded"
                        >
                            Add Expense
                        </button>
                    </div>
                    <div class="mt-8">
                        <h3 class="text-lg font-semibold mb-4">
                            Expense Breakdown
                        </h3>
                        {% if event.expenses %}
                        <table class="w-full">
                            <thead>
                                <tr class="bg-gray-100">
                                    <th class="px-4 py-2 text-left">
                                        Category
                                    </th>
                                    <th class="px-4 py-2 text-left">Amount</th>
                                    <th class="px-4 py-2 text-left">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for category, amount in
                                event.expenses.items() %}
                                <tr id="expense-{{ loop.index }}">
                                    <td class="border px-4 py-2">
                                        {{ category }}
                                    </td>
                                    <td class="border px-4 py-2">
                                        AED {{ "{:,.2f}".format(amount) }}
                                    </td>
                                    <td class="border px-4 py-2">
                                        <div class="flex space-x-2">
                                            <button
                                                onclick="openExpenseModal('{{ category }}', {{ amount }})"
                                                class="text-blue-600 hover:text-blue-800"
                                            >
                                                <svg
                                                    class="w-5 h-5"
                                                    fill="none"
                                                    stroke="currentColor"
                                                    viewBox="0 0 24 24"
                                                >
                                                    <path
                                                        stroke-linecap="round"
                                                        stroke-linejoin="round"
                                                        stroke-width="2"
                                                        d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"
                                                    />
                                                </svg>
                                            </button>
                                            <button
                                                onclick="deleteExpense('{{ category }}')"
                                                class="text-red-600 hover:text-red-800"
                                            >
                                                <svg
                                                    class="w-5 h-5"
                                                    fill="none"
                                                    stroke="currentColor"
                                                    viewBox="0 0 24 24"
                                                >
                                                    <path
                                                        stroke-linecap="round"
                                                        stroke-linejoin="round"
                                                        stroke-width="2"
                                                        d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"
                                                    />
                                                </svg>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        {% else %}
                        <p>No expenses recorded yet.</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>

<div
    id="editEventModal"
    class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full"
>
    <div
        class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white"
    >
        <h3 class="text-lg font-bold mb-4">Edit Event Details</h3>
        <form
            id="editEventForm"
            action="{{ url_for('app_views.event_details', event_id=event.event_id) }}"
            method="POST"
        >
            <input type="hidden" name="_method" value="PUT" />
            <div class="mb-4">
                <label
                    for="name"
                    class="block text-sm font-medium text-gray-700"
                    >Event Name</label
                >
                <input
                    type="text"
                    name="name"
                    id="name"
                    value="{{ event.name }}"
                    required
                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50"
                />
            </div>
            <div class="mb-4">
                <label
                    for="date"
                    class="block text-sm font-medium text-gray-700"
                    >Date</label
                >
                <input
                    type="date"
                    name="date"
                    id="date"
                    value="{{ event.date }}"
                    required
                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50"
                />
            </div>
            <div class="mb-4">
                <label
                    for="location"
                    class="block text-sm font-medium text-gray-700"
                    >Location</label
                >
                <input
                    type="text"
                    name="location"
                    id="location"
                    value="{{ event.location }}"
                    required
                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50"
                />
            </div>
            <div class="mb-4">
                <label
                    for="description"
                    class="block text-sm font-medium text-gray-700"
                    >Description</label
                >
                <textarea
                    name="description"
                    id="description"
                    rows="3"
                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50"
                >
{{ event.description }}</textarea
                >
            </div>
            <!-- Add budget field -->
            <div class="mb-4">
                <label
                    for="budget"
                    class="block text-sm font-medium text-gray-700"
                    >Budget (AED)</label
                >
                <input
                    type="number"
                    name="budget"
                    id="budget"
                    value="{{ event.budget or 0 }}"
                    min="{{ event.spent_budget or 0 }}"
                    step="0.01"
                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50"
                />
                <p class="text-sm text-gray-500 mt-1">
                    Minimum budget: AED {{ "{:,.2f}".format(event.spent_budget
                    or 0) }}
                </p>
            </div>
            <div class="mb-4">
                <label
                    for="status"
                    class="block text-sm font-medium text-gray-700"
                    >Status</label
                >
                <select
                    name="status"
                    id="status"
                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50"
                >
                    {% for status in EventStatus %}
                    <option
                        value="{{ status.value }}"
                        {%
                        if
                        event.status=="status.value"
                        %}
                        selected
                        {%
                        endif
                        %}
                    >
                        {{ status.value }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="flex justify-end">
                <button
                    type="button"
                    onclick="closeEditModal()"
                    class="mr-2 px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2"
                >
                    Cancel
                </button>
                <button
                    type="submit"
                    class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
                >
                    Update Event
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Task Modal -->
<div
    id="taskModal"
    class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full"
>
    <div
        class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white"
    >
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-bold" id="taskModalTitle">Add New Task</h3>
            <button
                onclick="closeTaskModal()"
                class="text-gray-600 hover:text-gray-800"
            >
                <svg
                    class="w-6 h-6"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                >
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M6 18L18 6M6 6l12 12"
                    />
                </svg>
            </button>
        </div>
        <form id="taskForm" onsubmit="handleTaskSubmit(event)">
            <input type="hidden" id="taskId" value="" />
            <div class="mb-4">
                <label
                    for="taskDescription"
                    class="block text-sm font-medium text-gray-700"
                    >Description</label
                >
                <textarea
                    id="taskDescription"
                    required
                    rows="3"
                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200"
                ></textarea>
            </div>
            <div class="mb-4">
                <label
                    for="taskDueDate"
                    class="block text-sm font-medium text-gray-700"
                    >Due Date</label
                >
                <input
                    type="date"
                    id="taskDueDate"
                    required
                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200"
                />
            </div>
            <div class="flex justify-end space-x-2">
                <button
                    type="button"
                    onclick="closeTaskModal()"
                    class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400"
                >
                    Cancel
                </button>
                <button
                    type="submit"
                    class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600"
                >
                    Save Task
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Add Guest Modal -->
<div
    id="guestModal"
    class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full"
>
    <div
        class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white"
    >
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-bold" id="guestModalTitle">
                Add New Guest
            </h3>
            <button
                onclick="closeGuestModal()"
                class="text-gray-600 hover:text-gray-800"
            >
                <svg
                    class="w-6 h-6"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                >
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M6 18L18 6M6 6l12 12"
                    />
                </svg>
            </button>
        </div>
        <form id="guestForm" onsubmit="handleGuestSubmit(event)">
            <input type="hidden" id="guestId" value="" />
            <div class="mb-4">
                <label
                    for="guestName"
                    class="block text-sm font-medium text-gray-700"
                    >Name</label
                >
                <input
                    type="text"
                    id="guestName"
                    required
                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200"
                />
            </div>
            <div class="mb-4">
                <label
                    for="guestEmail"
                    class="block text-sm font-medium text-gray-700"
                    >Email</label
                >
                <input
                    type="email"
                    id="guestEmail"
                    required
                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200"
                />
            </div>
            <div class="mb-4">
                <label
                    for="guestPhone"
                    class="block text-sm font-medium text-gray-700"
                    >Phone (Optional)</label
                >
                <input
                    type="tel"
                    id="guestPhone"
                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200"
                />
            </div>
            <div class="flex justify-end space-x-2">
                <button
                    type="button"
                    onclick="closeGuestModal()"
                    class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400"
                >
                    Cancel
                </button>
                <button
                    type="submit"
                    class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600"
                >
                    Save Guest
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Expense Modal -->
<div
    id="expenseModal"
    class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full"
>
    <div
        class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white"
    >
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-bold" id="expenseModalTitle">
                Add New Expense
            </h3>
            <button
                onclick="closeExpenseModal()"
                class="text-gray-600 hover:text-gray-800"
            >
                <svg
                    class="w-6 h-6"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                >
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M6 18L18 6M6 6l12 12"
                    />
                </svg>
            </button>
        </div>
        <form id="expenseForm" onsubmit="handleExpenseSubmit(event)">
            <input type="hidden" id="originalCategory" value="" />
            <div class="mb-4">
                <label
                    for="expenseCategory"
                    class="block text-sm font-medium text-gray-700"
                    >Category</label
                >
                <input
                    type="text"
                    id="expenseCategory"
                    required
                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200"
                />
            </div>
            <div class="mb-4">
                <label
                    for="expenseAmount"
                    class="block text-sm font-medium text-gray-700"
                    >Amount (AED)</label
                >
                <input
                    type="number"
                    id="expenseAmount"
                    required
                    min="0"
                    step="0.01"
                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200"
                />
            </div>
            <div class="flex justify-end space-x-2">
                <button
                    type="button"
                    onclick="closeExpenseModal()"
                    class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400"
                >
                    Cancel
                </button>
                <button
                    type="submit"
                    class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600"
                >
                    Save Expense
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %} {% block scripts %} {{ super() }}
<script>
    const eventId = {{ event.event_id }};

    // Tab switching functionality
    const tabBtns = document.querySelectorAll('.tab-btn');
    const tabContents = document.querySelectorAll('.tab-content');

    tabBtns.forEach(btn => {
        btn.addEventListener('click', () => {
            tabBtns.forEach(b => b.classList.remove('active', 'bg-blue-500', 'text-white'));
            btn.classList.add('active', 'bg-blue-500', 'text-white');

            const tabName = btn.dataset.tab;
            tabContents.forEach(content => {
                content.style.display = content.id === `${tabName}-content` ? 'block' : 'none';
            });
        });
    });

    function openEditModal() {
        document.getElementById('editEventModal').classList.remove('hidden');
    }

    function closeEditModal() {
        document.getElementById('editEventModal').classList.add('hidden');
    }

    document.getElementById('editEventForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        fetch('{{ url_for("app_views.event_details", event_id=event.event_id) }}', {
            method: 'PUT',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showFlashMessage(data.message, 'success');
                closeEditModal();
                setTimeout(() => {
                    location.reload();
                }, 1500);
            } else {
                showFlashMessage(data.error || 'Error updating event', 'error');
                console.error('Error details:', data);
            }
        })
        .catch(error => {
            console.error('Fetch error:', error);
            showFlashMessage('An error occurred while updating the event', 'error');
        });
    });

    document.querySelectorAll('a[href*="remove_vendor"]').forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();

            if (!confirm('Are you sure you want to remove this vendor from the event?')) {
                return;
            }

            const url = this.getAttribute('href');
            const vendorCard = this.closest('li');

            fetch(url, {
                method: 'DELETE',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(data.error);
                } else {
                    vendorCard.remove();
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while removing the vendor');
            });
        });
    });

    function deleteEvent() {
        if (!confirm('Are you sure you want to delete this event? This action cannot be undone.')) {
            return;
        }

        // This sends DELETE request to /event/<event_id>
        fetch(window.location.href, {
            method: 'DELETE',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                // This redirects to /events after successful deletion
                window.location.href = '{{ url_for("app_views.events") }}';
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while deleting the event');
        });
    }

    // Task CRUD Operations
    function openTaskModal(taskId = null) {
        const modal = document.getElementById('taskModal');
        const form = document.getElementById('taskForm');
        const title = document.getElementById('taskModalTitle');

        if (taskId) {
            title.textContent = 'Edit Task';
            const task = document.getElementById(`task-${taskId}`);
            document.getElementById('taskId').value = taskId;
            document.getElementById('taskDescription').value = task.querySelector('h3').textContent.trim();
            document.getElementById('taskDueDate').value = task.querySelector('p').textContent.replace('Due: ', '');
        } else {
            title.textContent = 'Add New Task';
            form.reset();
            document.getElementById('taskId').value = '';
        }

        modal.classList.remove('hidden');
    }

    function closeTaskModal() {
        document.getElementById('taskModal').classList.add('hidden');
    }

    // Update the task submission handler
    async function handleTaskSubmit(event) {
        event.preventDefault();
        const taskId = document.getElementById('taskId').value;
        const taskData = {
            name: document.getElementById('taskDescription').value,
            due_date: document.getElementById('taskDueDate').value
        };

        try {
            const response = await fetch(`/event/{{ event.event_id }}/tasks`, {
                method: taskId ? 'PUT' : 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify(taskId ? { ...taskData, task_id: taskId } : taskData)
            });

            const data = await response.json();

            if (data.success) {
                showFlashMessage(data.message || 'Task saved successfully', 'success');
                closeTaskModal();
                // Add a delay before reloading the page
                setTimeout(() => {
                    location.reload();
                }, 1000);
            } else {
                showFlashMessage(data.error || 'Error saving task', 'error');
            }
        } catch (error) {
            showFlashMessage('An error occurred while saving the task', 'error');
        }
    }

    async function deleteTask(taskId) {
        if (!confirm('Are you sure you want to delete this task?')) {
            return;
        }

        try {
            const response = await fetch(`/event/{{ event.event_id }}/tasks`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({ task_id: taskId })
            });

            const data = await response.json();
            if (data.success) {
                showFlashMessage(data.message, 'success');
                const taskElement = document.getElementById(`task-${taskId}`);
                taskElement.remove();
            } else {
                showFlashMessage(data.error, 'error');
            }
        } catch (error) {
            console.error('Error:', error);
            showFlashMessage('An error occurred while deleting the task', 'error');
        }
    }

    //status change handler
    async function updateTaskStatus(taskId, completed) {
        try {
            const response = await fetch(`/event/{{ event.event_id }}/tasks`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({
                    task_id: taskId,
                    status: completed ? 'completed' : 'pending'
                })
            });

            const data = await response.json();
            if (data.success) {
                const taskElement = document.getElementById(`task-${taskId}`);
                const taskName = taskElement.querySelector('h3');
                if (completed) {
                    taskName.classList.add('line-through', 'text-gray-500');
                } else {
                    taskName.classList.remove('line-through', 'text-gray-500');
                }
                showFlashMessage(data.message || 'Task updated successfully', 'success');
            } else {
                showFlashMessage(data.error || 'Failed to update task', 'error');
                event.target.checked = !completed;
            }
        } catch (error) {
            showFlashMessage('An error occurred while updating the task status', 'error');
            event.target.checked = !completed;
        }
    }

    // Guest CRUD Operations
    function openGuestModal(guestId = null) {
        const modal = document.getElementById('guestModal');
        const form = document.getElementById('guestForm');
        const title = document.getElementById('guestModalTitle');

        if (guestId) {
            title.textContent = 'Edit Guest';
            const row = document.getElementById(`guest-${guestId}`);
            const cells = row.getElementsByTagName('td');

            document.getElementById('guestId').value = guestId;
            document.getElementById('guestName').value = cells[0].textContent;
            document.getElementById('guestEmail').value = cells[1].textContent;
            document.getElementById('guestPhone').value = cells[2].textContent === 'N/A' ? '' : cells[2].textContent;
        } else {
            title.textContent = 'Add New Guest';
            form.reset();
            document.getElementById('guestId').value = '';
        }

        modal.classList.remove('hidden');
    }

    function closeGuestModal() {
        document.getElementById('guestModal').classList.add('hidden');
    }

    async function handleGuestSubmit(event) {
        event.preventDefault();

        const guestId = document.getElementById('guestId').value;
        const guestData = {
            name: document.getElementById('guestName').value.trim(),
            email: document.getElementById('guestEmail').value.trim(),
            phone: document.getElementById('guestPhone').value.trim()
        };

        if (!guestData.name || !guestData.email) {
            showFlashMessage('Please fill in all required fields', 'error');
            return;
        }

        try {
            const response = await fetch(`/event/{{ event.event_id }}/guests`, {
                method: guestId ? 'PUT' : 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify(guestId ? { ...guestData, guest_id: guestId } : guestData)
            });

            const data = await response.json();

            if (response.ok) {
                closeGuestModal();
                showFlashMessage(data.message || `Guest ${guestId ? 'updated' : 'added'} successfully`, 'success');
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            } else {
                showFlashMessage(data.error || 'Error saving guest', 'error');
            }
        } catch (error) {
            console.error('Error:', error);
            showFlashMessage('An error occurred while saving the guest', 'error');
        }
    }

    async function deleteGuest(guestId) {
        if (!confirm('Are you sure you want to remove this guest?')) {
            return;
        }

        try {
            const response = await fetch(`/event/{{ event.event_id }}/guests`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({ guest_id: guestId })
            });

            const data = await response.json();
            if (response.ok) {
                showFlashMessage(data.message || 'Guest removed successfully', 'success');
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            } else {
                showFlashMessage(data.error || 'Error removing guest', 'error');
            }
        } catch (error) {
            console.error('Error:', error);
            showFlashMessage('An error occurred while removing the guest', 'error');
        }
    }

    function editGuest(guest) {
        document.getElementById('guestId').value = guest.id;
        document.getElementById('guestName').value = guest.name;
        document.getElementById('guestEmail').value = guest.email;
        document.getElementById('guestPhone').value = guest.phone || '';
        document.getElementById('guestModalTitle').textContent = 'Edit Guest';
        openGuestModal();
    }

    async function sendInvitation(guestId) {
        try {
            const response = await fetch(`/event/{{ event.event_id }}/guests/${guestId}/invite`, {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });

            const data = await response.json();
            if (data.success) {
                showFlashMessage('Invitation sent successfully!', 'success');
            } else {
                showFlashMessage(data.error, 'error');
            }
        } catch (error) {
            console.error('Error:', error);
            showFlashMessage('An error occurred while sending the invitation', 'error');
        }
    }

    async function sendBulkInvitations() {
        if (!confirm('Are you sure you want to send invitations to all pending guests?')) {
            return;
        }

        try {
            const response = await fetch(`/event/{{ event.event_id }}/send-all-invitations`, {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });

            const data = await response.json();
            if (data.success) {
                showFlashMessage('All invitations sent successfully!', 'success');
            } else {
                showFlashMessage(data.error, 'error');
            }
        } catch (error) {
            console.error('Error:', error);
            showFlashMessage('An error occurred while sending invitations', 'error');
        }
    }

    // Expense CRUD Operations
    function openExpenseModal(category = null, amount = null) {
        const modal = document.getElementById('expenseModal');
        const form = document.getElementById('expenseForm');
        const title = document.getElementById('expenseModalTitle');

        if (category) {
            title.textContent = 'Edit Expense';
            document.getElementById('originalCategory').value = category;
            document.getElementById('expenseCategory').value = category;
            document.getElementById('expenseAmount').value = amount;
        } else {
            title.textContent = 'Add New Expense';
            form.reset();
            document.getElementById('originalCategory').value = '';
        }

        modal.classList.remove('hidden');
    }

    function closeExpenseModal() {
        document.getElementById('expenseModal').classList.add('hidden');
    }

    async function handleExpenseSubmit(event) {
        event.preventDefault();

        const category = document.getElementById('expenseCategory').value.trim();
        const amount = parseFloat(document.getElementById('expenseAmount').value);

        if (!category || isNaN(amount)) {
            showFlashMessage('Please fill in all fields correctly', 'error');
            return;
        }

        try {
            const response = await fetch(`/event/{{ event.event_id }}/expense/${encodeURIComponent(category)}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({ amount: amount })
            });

            const data = await response.json();

            if (response.ok) {
                closeExpenseModal();
                showFlashMessage(data.message || 'Expense added successfully', 'success');
                // Add delay before reload
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            } else {
                showFlashMessage(data.error || 'Error adding expense', 'error');
            }
        } catch (error) {
            console.error('Error:', error);
            showFlashMessage('An error occurred while adding the expense', 'error');
        }
    }

    async function deleteExpense(category) {
        if (!confirm('Are you sure you want to delete this expense?')) {
            return;
        }

        try {
            const response = await fetch(`/event/{{ event.event_id }}/expense/${encodeURIComponent(category)}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });

            const data = await response.json();
            if (data.success) {
                showFlashMessage(data.message || 'Expense deleted successfully', 'success');
                // Add delay before reload
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            } else {
                showFlashMessage(data.error || 'Error deleting expense', 'error');
            }
        } catch (error) {
            console.error('Error:', error);
            showFlashMessage('An error occurred while deleting the expense', 'error');
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        {% if is_new %}
        const createEventForm = document.getElementById('createEventForm');
        createEventForm.addEventListener('submit', async function(e) {
            e.preventDefault();

            try {
                const formData = new FormData(this);
                const response = await fetch('{{ url_for("app_views.create_event") }}', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    window.location.href = `/event/${data.event_id}`;
                } else {
                    alert(data.error || 'Error creating event');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('An error occurred while creating the event');
            }
        });
        {% endif %}
    });

    // Add this to clear any messages when leaving the page
    window.addEventListener('beforeunload', function() {
        const flashMessages = document.querySelectorAll('.flash-message');
        flashMessages.forEach(flash => flash.remove());
    });

    async function removeVendor(vendorId) {
        if (!confirm('Are you sure you want to remove this vendor from the event?')) {
            return;
        }

        try {
            const response = await fetch('/vendors', {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({
                    event_id: '{{ event.event_id }}',
                    vendor_id: vendorId
                })
            });

            const data = await response.json();
            if (response.ok) {
                showFlashMessage(data.message || 'Vendor removed successfully', 'success');
                // Remove the vendor element from the DOM
                const vendorElement = document.querySelector(`button[onclick="removeVendor('${vendorId}')"]`).closest('li');
                if (vendorElement) {
                    vendorElement.remove();
                }
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            } else {
                showFlashMessage(data.error || 'Error removing vendor', 'error');
            }
        } catch (error) {
            console.error('Error:', error);
            showFlashMessage('An error occurred while removing the vendor', 'error');
        }
    }

    async function updateTask(taskId) {
        try {
            const description = document.getElementById('task-description').value;
            const dueDate = document.getElementById('task-due-date').value;

            const response = await fetch(`/tasks/${taskId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    description: description,
                    due_date: dueDate
                })
            });

            const data = await response.json();

            if (response.ok) {
                // Use the flash message system from index.html
                showFlashMessage('Task updated successfully', 'success');

                // Update the task in the UI
                const taskElement = document.getElementById(`task-${taskId}`);
                if (taskElement) {
                    taskElement.querySelector('h3').textContent = description;
                    taskElement.querySelector('p').textContent = `Due: ${dueDate}`;
                }

                // Close the modal
                closeTaskModal();
            } else {
                showFlashMessage(data.error || 'Failed to update task', 'error');
            }
        } catch (error) {
            console.error('Error:', error);
            showFlashMessage('An error occurred while updating the task', 'error');
        }
    }

    // Update all vendor forms to use AJAX
    const vendorForms = document.querySelectorAll('form[action*="update_vendor_status"]');
    vendorForms.forEach(form => {
        form.addEventListener('submit', async function(e) {
            e.preventDefault();

            try {
                const response = await fetch(this.action, {
                    method: 'POST',
                    body: new FormData(this),
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });

                const data = await response.json();

                // Use the showFlashMessage function from index.html
                if (data.success) {
                    // Update status display
                    const vendorItem = this.closest('li');
                    const statusSpan = vendorItem.querySelector('span.font-semibold');
                    const newStatus = this.querySelector('select').value;
                    statusSpan.textContent = newStatus.charAt(0).toUpperCase() + newStatus.slice(1);
                    statusSpan.className = `font-semibold ${newStatus === 'confirmed' ? 'text-green-600' : 'text-yellow-600'}`;

                    // Show message and delay reload
                    window.showFlashMessage(data.message, 'success');
                    setTimeout(() => window.location.reload(), 2000);
                } else {
                    window.showFlashMessage(data.message, 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                window.showFlashMessage('An error occurred while updating the vendor status', 'error');
            }
        });
    });
</script>
{% endblock %}
